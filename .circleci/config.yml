version: 2
orbs:
  orb-docs:
    executors:
      hugo:
        docker:
          - image: cibuilds/hugo:latest
    commands:
      latest-cli-version:
        parameters:
          var-name: 
            description:
                "The name of an environment variable to store the version in.
                Defaults to CIRCLECI_CLI_LATEST_VERSION"
            default: CIRCLECI_CLI_LATEST_VERSION
            type: string
        steps:
          - run:
              name: "Save latest CircleCI CLI release version to an environment variable called << parameters.var-name >>"
              command: |
                export << parameters.var-name >>=`curl --silent "https://api.github.com/repos/CircleCI-Public/circleci-cli/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/'` 
                echo $<< parameters.var-name >>
      install-circleci-cli:
        parameters:
          root-url:
            description: the root URL used to generate the download link. You almost certainly can rely on the default value.
            type: string
            default: "https://github.com/CircleCI-Public/circleci-cli/releases/download/"

        steps:
          - latest-cli-version
          - run:
              name: "Install `circleci` CLI"
              command: |
                echoerr ()
                {
                    echo "$@" >&2
                }
                if [ $(uname) == "Darwin" ]; then
                  OS=darwin
                elif [ $(expr substr $(uname -s) 1 5) == "Linux" ]; then
                  OS=linux
                else
                  echoerr "This installer is only supported on Linux and MacOS"
                  exit 1
                fi
                ARCH="$(uname -m)"
                echo "arch string found: $ARCH"
                if [ $ARCH == "x863_64" ]; then
                  ARCH=x64
                elif [[ $ARCH == arm* ]]; then
                  ARCH=arm
                else
                  echoerr "unsupported arch: $ARCH"
                  exit 1
                fi
                download_url=<< parameters.root-url >>$(CIRCLECI_CLI_LATEST_VERSION)/circleci-cli_${CIRCLECI_CLI_LATEST_VERSION#v)_${OS}_${ARCH}.tar.gz
                echo $download_url
                
jobs:
  build:
    executor: orb-docs/hugo
    steps:
      - orb-docs/install-circleci-cli



version: 2.1

orbs:
  myorb:
    executors:
      default:
        parameters:
          image-name:
            type: string
            default: "cimg/rust"
          image-tag:
            type: string
            default: "1.50.0"
        docker:
          - image: << parameters.image-name>>:<< parameters.image-tag >>

  rover:
    commands:
      install:
        parameters:
          version:
            type: string
            default: "v0.0.4"
        steps:
          ## TODO: don't install if we already have this version installed, unless a force parameter is true
          - run: curl -sSL https://raw.githubusercontent.com/apollographql/rover/<< parameters.version >>/installers/binstall/scripts/nix/install.sh | sh
          - run: echo 'export PATH=$HOME/.rover/bin:$PATH' >> $BASH_ENV
      build:
        parameters:
          path:
            type: string
        steps:
          - run: rover core build --config << parameters.path >>
  

commands:
  bootstrap-build:
    steps:
      - run: rover graph fetch rickmorty@current > rickmorty.graphql
      - run: rover graph fetch countries1@current > countries.graphql
      - run: |
          echo "subgraphs: { rick-and-morty: {routing_url: 'https://rickandmortyapi.com/graphql', schema: { file: 'rickmorty.graphql' }} }" > supergraph1.yml


jobs:
  build:
    executor: myorb/default
    steps:
      - checkout
      - run: docker -v
      - rover/install
      - run: rover --version
      - bootstrap-build
      - rover/build:
          path: supergraph1.yml
  
workflows:
  mine:
    jobs:
      - build




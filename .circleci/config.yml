version: 2.1

parameters:
  subgraphs-file:
    type: string
    default: "subgraphs.yml"
  supergraph-file:
    type: string
    default: supergraph.graphql
  port:
    type: integer
    default: 4000
  federated-graphref:
    type: string
    default: funkyfederation


executors:
  default:
    parameters:
      tag:
        type: string
        default: "14.16.0-browsers"
    docker:
      - image: cimg/node:<< parameters.tag >>

jobs:
  retrieve-and-publish:
    executor: rover/default
    steps:
      - rover/install
      - run: rover update check
      - run: rover graph introspect https://rickandmortyapi.com/graphql | rover graph publish rickmorty@current --schema -
      - run: rover graph introspect https://countries.trevorblades.com/ | rover graph publish countries1@current --schema -

  publish-subgraphs:
    executor: rover/default
    steps:
      - rover/install
      - run: rover update check
      # - run: rover config whoami
      - run: rover graph fetch rickmorty@current > rickmorty.graphql
      - run: rover graph fetch countries1@current > countries.graphql
      - run: 
          name: Publish subgraph rickmorty
          command: rover subgraph publish << pipeline.parameters.federated-graphref >> --routing-url https://rickandmortyapi.com/graphql --schema rickmorty.graphql --name rickmorty
      - run:
          name: Publish subgraph countries
          command: rover subgraph publish << pipeline.parameters.federated-graphref >> --routing-url https://countries.trevorblades.com/ --schema countries.graphql --name countries
  
  compose_supergraph:
    parameters:
      config:
        type: string
        default: >
          subgraphs: {
            rick-and-morty: {
              routing_url: 'https://rickandmortyapi.com/graphql',
              schema: { file: 'rickmorty.graphql' }
            },
            countries: {
              routing_url: 'https://countries.trevorblades.com/',
              schema: { file: 'countries.graphql'}
            }
          }

    executor: rover/default
    steps:
      - rover/install
      - run: rover update check
      # - run: rover config whoami
      - run: rover graph fetch rickmorty@current > rickmorty.graphql
      - run: rover graph fetch countries1@current > countries.graphql
      - run: 
          name: write config file to << pipeline.parameters.subgraphs-file >>
          command: |
            echo "<< parameters.config >>" > << pipeline.parameters.subgraphs-file >>
      - rover/compose:
          config: << pipeline.parameters.subgraphs-file >>
          file: << pipeline.parameters.supergraph-file >>
          workspace: true

  run-local-supergraph:
    executor: default
    steps:
      - attach_workspace:
          at: "."
      - run: 
          name: install special versions of gateway, federation, query-planner
          command: |
            npm init --yes
            npm install apollo-server graphql
            npm i https://7710-252760990-gh.circle-artifacts.com/0/storage/%40apollo/federation/federation-0.22.0.tgz
            npm i https://7710-252760990-gh.circle-artifacts.com/0/storage/%40apollo/query-planner/query-planner-0.0.13.tgz
            npm i https://7710-252760990-gh.circle-artifacts.com/0/storage/%40apollo/gateway/gateway-0.24.4.tgz
      - run:
          name: show contents of << pipeline.parameters.supergraph-file >> (in the attached workspace)
          command: cat << pipeline.parameters.supergraph-file >>
      - write-gateway-index:
          use-supergraph: true
      - run:
          command: APOLLO_KEY=$APOLLO_KEY_GATEWAY APOLLO_GRAPH_VARIANT=current THISIP=$(node -p "require('ip').address()") node index.js
          background: true
          name: start gateway with a supergraph
      - query-gateway
 
  run-managed-federation:
    executor: default
    steps:
      - run:
          name: npm install apollo-server graphql @apollo/gateway
          command: |
            npm init --yes
            npm install apollo-server graphql @apollo/gateway
      - write-gateway-index
      - run:
          command: APOLLO_KEY=$APOLLO_KEY_GATEWAY APOLLO_GRAPH_VARIANT=current THISIP=$(node -p "require('ip').address()") node index.js
          background: true
          name: start gateway
      - query-gateway

commands:
  write-gateway-index:
    parameters:
      file:
        type: string
        default: index.js
      use-supergraph:
        type: boolean
        default: false
    steps:
      - run:
          name: "write the gateway startup code to << parameters.file >>; use-supergraph: << parameters.use-supergraph >>"
          command: |
            STUFF=$(cat \<<END_HEREDOC
            const { ApolloServer } = require('apollo-server');
            const { ApolloGateway } = require('@apollo/gateway');
            const { readFileSync } = require('fs');

            // Pass the ApolloGateway to the ApolloServer constructor
            console.log("start the server... {process.env.THISIP}");

            const gateway = new ApolloGateway(
              <<# parameters.use-supergraph >>{supergraphSdl: readFileSync("./<< pipeline.parameters.supergraph-file >>").toString(),}<</ parameters.use-supergraph >>
            );
            
            const server = new ApolloServer({
              gateway,
              debug: true,
              // Subscriptions are unsupported but planned for a future Gateway version.
              subscriptions: false
            });
            server.listen({host: process.env.THISIP, port: << pipeline.parameters.port >>}).then((result) => {
              console.log("Success", result);
            }).catch(err => {console.error(err)});
            END_HEREDOC
            )
            echo "$STUFF"
            echo "$STUFF" > << parameters.file >>
  
  query-gateway:
    steps:
      - run:
          name: wait up to a minute until the gateway is ready
          command: while ! nc -z $(node -p "require('ip').address()") << pipeline.parameters.port >>; do sleep 0.1 ; done
          no_output_timeout: 30s
      - run: 
          name: query the gateway
          command: |
            curl \
            -X POST \
            -H "Content-Type: application/json" \
            --data '{ "query": "{ continents { name } characters { results { name } } } " }' \
            http://$(node -p "require('ip').address()"):<< pipeline.parameters.port >>/ \
            -o result.json
      - run:
          name: show the resulting query
          command: jq . result.json

orbs:
  rover:
    executors:
      default:
        parameters:
          image-name:
            type: string
            default: "cimg/node"
          image-tag:
            type: string
            default: "15.11.0"
        docker:
          - image: << parameters.image-name>>:<< parameters.image-tag >>
    commands:
      install:
        parameters:
          version:
            type: string
            default: "v0.0.5"
        steps:
          ## TODO: don't install if we already have this version installed, unless a force parameter is true
          - run:
              name: install rover version << parameters.version >>
              command: |
                curl -sSL https://raw.githubusercontent.com/apollographql/rover/<< parameters.version >>/installers/binstall/scripts/nix/install.sh | sh
                echo 'export PATH=$HOME/.rover/bin:$PATH' >> $BASH_ENV
      compose:
        description: "Composes the given `config` (path to config file) to a file called supergraph.graphql (override with `file`). Optionally, persist to workspace."
        parameters:
          config:
            type: string
          file:
            type: string
            default: "supergraph.graphql"
          workspace:
            type: boolean
            default: false

        steps:
          - when:
              condition:
                equal:
                  - << parameters.config >>
                  - << parameters.file >>
              steps:
                - run:
                    name: "ERROR: config and file parameters cannot be the same when calling rover/compose - name: << parameters.config >>"
                    command: echo "Sorry, the config and destination file can't be the same. (<< parameters.config >>)" && exit 1
          - run: rover supergraph compose --config << parameters.config >> > << parameters.file >> && cat << parameters.file >>
          - when:
              condition: << parameters.workspace >>
              steps:
                - persist_to_workspace:
                    root: "."
                    paths:
                      - << parameters.file >>

workflows:
  mine:
    jobs:
      - retrieve-and-publish
      - publish-subgraphs:
          requires:
            - retrieve-and-publish
      - compose_supergraph:
          requires:
            - retrieve-and-publish
      - run-managed-federation:
          requires:
            - publish-subgraphs
      - run-local-supergraph:
          requires:
            - compose_supergraph


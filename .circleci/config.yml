version: 2.1
parameters:
  image-tag:
    type: string
    default: "latest"
  workingdir:
    type: string
    default: "~/main"
  cache-version:
    type: string
    default: "v1"

commands:
  cached-checkout:
    parameters:
      cache-version:
        type: string
        default: << pipeline.parameters.cache-version >>
    steps:
      - restore_cache:
                keys:
                  - << parameters.cache-version >>-{{ .Branch }}-{{ .Revision }}
                  - << parameters.cache-version >>-{{ .Branch }}-
      - checkout
      - save_cache:
          key: << parameters.cache-version >>-{{ .Branch }}-{{ .Revision }}
          paths:
            - ".git"

jobs:
  build:
    docker:
      - image: circleci/node:<< pipeline.parameters.image-tag >>
    environment:
      IMAGETAG: << pipeline.parameters.image-tag >>
    working_directory: << pipeline.parameters.workingdir >>
    steps:
      - run: echo "No. << pipeline.number >> ID << pipeline.id >>"
      - run: echo "Image tag used was << pipeline.parameters.image-tag >>"
      - run: echo "Image tag used was ${IMAGETAG}"
      - run: echo "$(pwd) == << pipeline.parameters.workingdir >>"
      - run: echo "Cache Version << pipeline.parameters.cache-version >>"
      - cached-checkout

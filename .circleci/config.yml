
version: 2.1

executors:
  default:
    parameters:
      image-name:
        type: string
        default: "cimg/node"
      image-tag:
        type: string
        default: "14.16.0-browsers"
    docker:
      - image: << parameters.image-name>>:<< parameters.image-tag >>

parameters:
  config-file:
    type: string
    default: "supergraph.yml"
  port:
    type: integer
    default: 4000
  graphref:
    type: string
    default: funkyfederation
  config:
    type: string
    default: >
      subgraphs: {
        rick-and-morty: {
          routing_url: 'https://rickandmortyapi.com/graphql',
          schema: { file: 'rickmorty.graphql' }
        },
        countries: {
          routing_url: 'https://countries.trevorblades.com/',
          schema: { file: 'countries.graphql'}
        }
      }

commands:
  fetch-schema:
    steps:
      - run: rover graph fetch rickmorty@current > rickmorty.graphql
      - run: rover graph fetch countries1@current > countries.graphql
      - run: |
          echo "<< pipeline.parameters.config >>" > << pipeline.parameters.config-file >>

  write-gateway-index:
    parameters:
      file:
        type: string
        default: index.js
    steps:
      - run:
          command: |
            STUFF=$(cat \<<END_HEREDOC
            const { ApolloServer } = require('apollo-server');
            const { ApolloGateway } = require('@apollo/gateway');
            // Pass the ApolloGateway to the ApolloServer constructor
            console.log("start the server... {process.env.THISIP}");
            const gateway = new ApolloGateway();
            const server = new ApolloServer({
              gateway,
              debug: true,
              // Subscriptions are unsupported but planned for a future Gateway version.
              subscriptions: false
            });
            server.listen({host: process.env.THISIP, port: << pipeline.parameters.port >>}).then((result) => {
              console.log("Success", result);
            }).catch(err => {console.error(err)});
            END_HEREDOC
            )
            echo "$STUFF"
            echo "$STUFF" > << parameters.file >>



jobs:
  setup-supergraph:
    executor: rover/default
    steps:
      - rover/install
      - run: rover --version
      - fetch-schema
      - rover/build:
          path: << pipeline.parameters.config-file >>
          persist-to-workspace: true

      - run: 
          name: Publish subgraph rickmorty
          command: rover subgraph publish << pipeline.parameters.graphref >> --routing-url https://rickandmortyapi.com/graphql --schema rickmorty.graphql --name rickmorty
      - run:
          name: Publish subgraph countries
          command: rover subgraph publish << pipeline.parameters.graphref >> --routing-url https://countries.trevorblades.com/ --schema countries.graphql --name countries
    

  rungateway-managed-federation:
    executor: default
    steps:
      - run: npm init --yes
      - run: npm install apollo-server graphql @apollo/gateway
      - write-gateway-index
      - run:
          command: APOLLO_KEY=$APOLLO_KEY_GATEWAY APOLLO_GRAPH_VARIANT=current THISIP=$(node -p "require('ip').address()") node index.js
          background: true
          name: start gateway
      - run:
          name: wait until the gateway is ready
          command: while ! nc -z $(node -p "require('ip').address()") << pipeline.parameters.port >>; do  sleep 0.1; done
      - run: 
          name: query the gateway
          command: |
            curl \
            -X POST \
            -H "Content-Type: application/json" \
            --data '{ "query": "{ continents { name } characters { results { name } } } " }' \
            http://$(node -p "require('ip').address()"):<< pipeline.parameters.port >>/

orbs:
  rover:
    executors:
      default:
        parameters:
          image-name:
            type: string
            default: "cimg/node"
          image-tag:
            type: string
            default: "15.11.0"
        docker:
          - image: << parameters.image-name>>:<< parameters.image-tag >>
    commands:
      install:
        parameters:
          version:
            type: string
            default: "v0.0.5"
        steps:
          ## TODO: don't install if we already have this version installed, unless a force parameter is true
          - run: curl -sSL https://raw.githubusercontent.com/apollographql/rover/<< parameters.version >>/installers/binstall/scripts/nix/install.sh | sh
          - run: echo 'export PATH=$HOME/.rover/bin:$PATH' >> $BASH_ENV
      compose:
        parameters:
          path:
            type: string
          file:
            type: string
            default: "supergraph.yml"
          persist-to-workspace:
            type: boolean
            default: false

        steps:
          - run: rover supergraph compose --config << parameters.path >> > << parameters.file >>
          - when:
              condition: << parameters.persist-to-workspace >>
              steps:
                - persist-to-workspace:
                    root: "."
                    paths:
                      - << parameters.file >>


    
workflows:
  mine:
    jobs:
      - setup-supergraph
      - rungateway:
          requires:
            - setup-supergraph


version: 2.1
parameters:
  image-tag:
    type: string
    default: "latest"
  workingdir:
    type: string
    default: "~/main"
  cache-version:
    type: string
    default: "v1"

jobs:
  build:
    docker:
      - image: circleci/node:<< pipeline.parameters.image-tag >>
    environment:
      IMAGETAG: << pipeline.parameters.image-tag >>
    working_directory: << pipeline.parameters.workingdir >>
    steps:
      - run: echo "Image tag used was ${IMAGETAG}"
      - run: echo "$(pwd) == << pipeline.parameters.workingdir >>"
      - restore_cache:
                keys:
                  - << pipeline.cache-version >>-{{ .Branch }}-{{ .Revision }}
                  - << pipeline.cache-version >>-{{ .Branch }}-
      - checkout
      - save_cache:
          key: << pipeline.cache-version >>-{{ .Branch }}-{{ .Revision }}
          paths:
            - ".git"

workflows:
  one:
    jobs:
      - build
      - build:
          requires:
            - build
